function printProperties(e){var r="";for(var i in e)r+=i+"="+e[i]+"\n";alert(r)}var imhere=function(){return{initImhere:function(){var e=new $.Deferred;imhere.LogonPage.initModule(),imhere.MainPage.initModule(),imhere.GoogleMapPage.initModule();var r=new imhere.IndexedDbAPI;return r.openDB().then(function(){r.searchToken("twitter").then(function(r){var i;if(r===i)var n=new imhere.TwitterAPI;else var n=new imhere.TwitterAPI(r.at,r.ats);e.resolve({twitterAPI:n})})}),e.promise()}}}(),IMHERE_HASHTAG="#imhereintyo";
imhere.utils=function(){},imhere.utils.getUrlVarsFromLocationHref=function(){return imhere.utils.getUrlVars(window.location.href)},imhere.utils.getUrlVars=function(t){for(var a,e=[],i=t.slice(t.indexOf("?")+1).split("&"),n=0;n<i.length;n++)a=i[n].split("="),e.push(a[0]),e[a[0]]=a[1];return e},imhere.utils.getPositionFromTweet=function(t){var a,e={};return-1==t.search(/Lat:(\d+.\d+)\//)?a:(e.latitude=RegExp.$1,-1==t.search(/\/Long:(\d+.\d+)/)?a:(e.longitude=RegExp.$1,e))},imhere.utils.getAccuracyText=function(t){return isFinite(t)?1e3>t?t+"m":t>=1e3?t/1e3+"km orz..":void 0:"NaN"},imhere.utils.getCreatedTimeText=function(t){try{var a=t.slice(4),e=moment(a,"MMM DD HH:mm:ss Z YYYY");return e.format("MMM DD HH:mm:ss")+"(JST)"}catch(i){return"Invalid date"}},imhere.utils.deleteCookie=function(t){cName=t+"=",dTime=new Date,dTime.setYear(dTime.getYear()-1),document.cookie=cName+";expires="+dTime.toGMTString()},imhere.utils.playAudio=function(){var t="/android_asset/www/sound/imhere.mp3",a=new Media(t,function(){console.log("playAudio():Audio Success")},function(t){console.log("playAudio():Audio Error: "+t)});a.play()},imhere.utils.geoDistance=function(t,a,e,i,n){var h;n===h&&(n=0);var o=0;if(Math.abs(t-e)<1e-5&&Math.abs(a-i)<1e-5)o=0;else{t=t*Math.PI/180,a=a*Math.PI/180,e=e*Math.PI/180,i=i*Math.PI/180;var r=6378140,s=6356755,M=(r-s)/r,u=Math.atan(s/r*Math.tan(t)),c=Math.atan(s/r*Math.tan(e)),l=Math.acos(Math.sin(u)*Math.sin(c)+Math.cos(u)*Math.cos(c)*Math.cos(a-i)),m=M/8*((Math.sin(l)-l)*Math.pow(Math.sin(u)+Math.sin(c),2)/Math.pow(Math.cos(l/2),2)-(Math.sin(l)-l)*Math.pow(Math.sin(u)-Math.sin(c),2)/Math.pow(Math.sin(l),2));o=r*(l+m);var d=Math.pow(10,n);o=Math.round(d*o/1)/d}return o},imhere.utils.geoDirection=function(t,a,e,i){var n=Math.cos(i*Math.PI/180)*Math.sin(e*Math.PI/180-t*Math.PI/180),h=Math.cos(a*Math.PI/180)*Math.sin(i*Math.PI/180)-Math.sin(a*Math.PI/180)*Math.cos(i*Math.PI/180)*Math.cos(e*Math.PI/180-t*Math.PI/180),o=180*Math.atan2(n,h)/Math.PI;0>o&&(o+=360);var r=(o+90)%360;return r>22.5&&67.5>=r?"北東":r>67.5&&112.5>=r?"東":r>112.5&&157.5>=r?"南東":r>157.5&&202.5>=r?"南":r>202.5&&247.5>=r?"南西":r>247.5&&272.5>=r?"西":r>272.5&&337.5>=r?"北西":"北"};
window.indexedDB=window.indexedDB||window.webkitIndexedDB||window.mozIndexedDB,"webkitIndexedDB"in window&&(window.IDBTransaction=window.webkitIDBTransaction,window.IDBKeyRange=window.webkitIDBKeyRange),imhere.IndexedDbAPI=function(){this.iDB={}},imhere.IndexedDbAPI.prototype.openDB=function(){var e=new $.Deferred,r=this,o=indexedDB.open("imhereDB",1);return o.onsuccess=function(){r.iDB=o.result,e.resolve()},o.onerror=function(r){console.log("IndexedDB error: "+r.target.errorCode),e.reject("IndexedDB error: "+r.target.errorCode)},o.onupgradeneeded=function(e){r.iDB=o.result,r.iDB.objectStoreNames.contains("atokenStore")&&o.result.deleteObjectStore("atokenStore");e.target.result.createObjectStore("atokenStore",{keyPath:"rservice"});console.log("objectStore defined.")},e.promise()},imhere.IndexedDbAPI.prototype.searchToken=function(e){var r=new $.Deferred,o=this.iDB,t=o.transaction(["atokenStore"],"readwrite"),n=t.objectStore("atokenStore"),d=n.get(e);return d.onsuccess=function(e){var o=e.target.result;r.resolve(o)},d.onerror=function(e){console.log("IndexedDB error: "+e.target.errorCode),r.reject("IndexedDB error: "+e.target.errorCode)},r.promise()},imhere.IndexedDbAPI.prototype.addToken=function(e,r){var o=new $.Deferred,t=this.iDB,n=t.transaction(["atokenStore"],"readwrite"),d=n.objectStore("atokenStore"),i={rservice:e,at:r.at,ats:r.ats},c=d.put(i);return c.onsuccess=function(e){console.log("Success Adding: ",e),o.resolve()},c.onerror=function(e){console.log("IndexedDB error: "+e.target.errorCode),o.reject("IndexedDB error: "+e.target.errorCode)},o.promise()},imhere.IndexedDbAPI.prototype.deleteToken=function(e){var r=new $.Deferred,o=this.iDB,t=o.transaction(["atokenStore"],"readwrite"),n=t.objectStore("atokenStore"),d=n.delete(e);return d.onsuccess=function(e){console.log("Success Adding: ",e),r.resolve()},d.onerror=function(e){console.log("IndexedDB error: "+e.target.errorCode),r.reject("IndexedDB error: "+e.target.errorCode)},r.promise()};
imhere.MetroAPI=function(){this.consumer={consumerKey:"8e0dce63eacba7c35b6ae80c0aa5213385a3d03e04729c3f5926cb9ad8e060cf",datapointsUrl:"https://api.tokyometroapp.jp/api/v2/datapoints?",placeUrl:"https://api.tokyometroapp.jp/api/v2/places?"},this.trainName={"odpt.Railway:TokyoMetro.Chiyoda":"千代田線","odpt.Railway:TokyoMetro.Fukutoshin":"副都心線","odpt.Railway:TokyoMetro.Ginza":"銀座線","odpt.Railway:TokyoMetro.Hibiya":"日比谷線","odpt.Railway:TokyoMetro.Marunouchi":"丸ノ内線","odpt.Railway:TokyoMetro.Namboku":"南北線","odpt.Railway:TokyoMetro.Tozai":"東西線","odpt.Railway:TokyoMetro.Yurakucho":"有楽町線","odpt.Railway:TokyoMetro.Hanzomon":"半蔵門線"}},imhere.MetroAPI.prototype.getCurrentPosition=function(){var e=new $.Deferred;return navigator.geolocation.getCurrentPosition(function(t){e.resolve({latitude:t.coords.latitude,longitude:t.coords.longitude,accuracy:t.coords.accuracy})},function(t){e.reject(t)},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}),e.promise()},imhere.MetroAPI.prototype.getNearStation=function(e){var t=new $.Deferred;return this.getNearestStation(e,"1500",t)},imhere.MetroAPI.prototype.getNearestStation=function(e,t,r){var o,a;t!==a?(e.radius=t,o=r):(e.radius="200",o=new $.Deferred),e.type="odpt:Station";var n=imhere.MetroAPI.getPlaceUrl(this,e),i={type:"GET",url:n,success:function(e){var t="undefined";e.length>0&&(t={title:e[0]["dc:title"],lat:e[0]["geo:lat"],"long":e[0]["geo:long"],railway:e[0]["odpt:railway"],connectingrailway:e[0]["odpt:connectingRailway"],sameas:e[0]["owl:sameAs"]}),o.resolve(t)},error:function(e){o.reject(e)}};return $.ajax(i),o.promise()},imhere.MetroAPI.prototype.getLocationBetweenStations=function(e,t){var r=new $.Deferred;e.radius="2000",e.type="odpt:Station";var o=imhere.MetroAPI.getPlaceUrl(this,e),a={type:"GET",url:o,success:function(e){for(var o=[],a=0;a<e.length;a++)e[a]["odpt:railway"]===t.sameas&&o.push({title:e[a]["dc:title"],lat:e[a]["geo:lat"],"long":e[a]["geo:long"]});o.length<2&&(o="undefined"),r.resolve(o)},error:function(e){r.reject(e)}};return $.ajax(a),r.promise()},imhere.MetroAPI.prototype.getNearestExit=function(e){var t=new $.Deferred;e.radius="30",e.type="ug:Poi";var r=imhere.MetroAPI.getPlaceUrl(this,e),o={type:"GET",url:r,success:function(e){var r="undefined";e.length>0&&(r={title:e[0]["dc:title"],lat:e[0]["geo:lat"],"long":e[0]["geo:long"]}),t.resolve(r)},error:function(e){t.reject(e)}};return $.ajax(o),t.promise()},imhere.MetroAPI.prototype.getNearestRailway=function(e){var t=new $.Deferred;e.radius="150",e.type="odpt:Railway";var r=imhere.MetroAPI.getPlaceUrl(this,e),o={type:"GET",url:r,success:function(e){var r="undefined";e.length>0&&(r={title:e[0]["dc:title"],lat:e[0]["geo:lat"],"long":e[0]["geo:long"],sameas:e[0]["owl:sameAs"]}),t.resolve(r)},error:function(e){t.reject(e)}};return $.ajax(o),t.promise()},imhere.MetroAPI.prototype.getTrainInformation=function(e){var t,r=new $.Deferred,o={};o.type="odpt:TrainInformation";var a=e.sameas.replace("Branch","");o.condition={prop:"odpt:railway",value:a};var n=imhere.MetroAPI.getDataPointsUrl(this,o),i={type:"GET",url:n,success:function(e){var o="undefined";e.length>0&&(o={trainInformationText:e[0]["odpt:trainInformationStatus"]},o=o.trainInformationText===t?{trainInformationText:e[0]["odpt:trainInformationText"]}:{trainInformationText:e[0]["odpt:trainInformationStatus"]+"しています。"}),r.resolve(o)},error:function(e){r.reject(e)}};return $.ajax(i),r.promise()},imhere.MetroAPI.prototype.getRelatedTrainInformation=function(e){var t,r=new $.Deferred,o=this,a={};a.type="odpt:TrainInformation";var n=imhere.MetroAPI.getDataPointsUrl(this,a),i={type:"GET",url:n,success:function(a){var n=[];if(a.length>0){var i=e.connectingrailway;i.push(e.railway);for(var l=0;l<a.length;l++)for(var c={railway:a[l]["odpt:railway"],trainInformationText:a[l]["odpt:trainInformationText"],trainInformationStatus:a[l]["odpt:trainInformationStatus"]},u=0;u<i.length;u++){var s=i[u];s=s.replace("Branch",""),c.railway===s&&c.trainInformationStatus!==t&&n.push(o.trainName[c.railway]+"は、"+c.trainInformationStatus+"しています。")}}r.resolve(n)},error:function(e){r.reject(e)}};return $.ajax(i),r.promise()},imhere.MetroAPI.getPlaceUrl=function(e,t){return e.consumer.placeUrl+"rdf:type="+t.type+"&lon="+t.longitude+"&lat="+t.latitude+"&radius="+t.radius+"&acl:consumerKey="+e.consumer.consumerKey},imhere.MetroAPI.getDataPointsUrl=function(e,t){var r,o=e.consumer.datapointsUrl+"rdf:type="+t.type;return t.condition!==r&&(o=o+"&"+t.condition.prop+"="+t.condition.value),o=o+"&acl:consumerKey="+e.consumer.consumerKey};
imhere.TwitterAPI=function(e,t){this.consumer={consumerKey:"QS31zTayk8JraIqyEMpqYNKpM",consumerSecret:"vTWbyyXbIFgQnOH65TPlGzdmXzVvHodewttw5HH00xqCVEDShQ"},this.token="",this.token_secret="",this.atoken=e,this.atoken_secret=t},imhere.TwitterAPI.prototype.isAvailable=function(){var e;return this.atoken!==e?!0:!1},imhere.TwitterAPI.prototype.getRequestToken=function(){var e=new $.Deferred,t={consumerSecret:this.consumer.consumerSecret,tokenSecret:""},r={method:"GET",action:"https://twitter.com/oauth/request_token",parameters:{oauth_callback:"http://127.0.0.1/imhere/index.html",oauth_consumer_key:this.consumer.consumerKey,oauth_signature_method:"HMAC-SHA1"}};OAuth.setTimestampAndNonce(r),OAuth.SignatureMethod.sign(r,t);var o=OAuth.addToURL(r.action,r.parameters),n=this,s={type:r.method,url:o,success:function(t){t.search(/oauth_token=([\w-]+)\&/),n.token=RegExp.$1,t.search(/oauth_token_secret=([\w-]+)\&/),n.token_secret=RegExp.$1,e.resolve()},error:function(t){e.reject(t)}};return $.ajax(s),e.promise()},imhere.TwitterAPI.prototype.userAuthentication=function(){function e(e){var r=e.url,o=imhere.utils.getUrlVars(e.url).oauth_token,a=imhere.utils.getUrlVars(e.url).oauth_verifier;a!==s?(n.close(),t.resolve(o,a)):-1!=r.indexOf("cancel")?(n.close(),t.resolve(o,a)):-1!=r.indexOf("?denied=")&&(n.close(),t.resolve(o,a))}var t=new $.Deferred,r={consumerSecret:this.consumer.consumerSecret,tokenSecret:this.token_secret},o={method:"GET",action:"https://twitter.com/oauth/authorize",parameters:{oauth_signature_method:"HMAC-SHA1",oauth_consumer_key:this.consumer.consumerKey,oauth_token:this.token,force_login:"false"}};OAuth.setTimestampAndNonce(o),OAuth.SignatureMethod.sign(o,r);var n,s,a=OAuth.addToURL(o.action,o.parameters),i={type:o.method,url:a,success:function(){}};return n=window.open(i.url,"_blank","location=no"),n.addEventListener("loadstart",e),t.promise()},imhere.TwitterAPI.prototype.getAccessToken=function(e,t){var r=new $.Deferred,o={consumerSecret:this.consumer.consumerSecret,tokenSecret:this.token_secret},n={method:"GET",action:"https://twitter.com/oauth/access_token",parameters:{oauth_signature_method:"HMAC-SHA1",oauth_consumer_key:this.consumer.consumerKey,oauth_token:e,oauth_verifier:t}};OAuth.setTimestampAndNonce(n),OAuth.SignatureMethod.sign(n,o);var s=OAuth.addToURL(n.action,n.parameters),a=this,i={type:n.method,url:s,success:function(e){e.search(/oauth_token=([\w-]+)\&/),a.atoken=RegExp.$1,e.search(/oauth_token_secret=([\w-]+)\&/),a.atoken_secret=RegExp.$1,r.resolve(a.atoken,a.atoken_secret)},error:function(e){r.reject(e)}};return $.ajax(i),r.promise()},imhere.TwitterAPI.prototype.post=function(e,t,r){var o={consumerSecret:this.consumer.consumerSecret,tokenSecret:this.atoken_secret},n={method:"POST",action:e,parameters:{oauth_signature_method:"HMAC-SHA1",oauth_consumer_key:this.consumer.consumerKey,oauth_token:this.atoken}};for(var s in t)n.parameters[s]=t[s];OAuth.setTimestampAndNonce(n),OAuth.SignatureMethod.sign(n,o);var a=OAuth.addToURL(n.action,n.parameters),i={type:n.method,url:a,dataType:"json",success:function(e,t){r.resolve(e,t)},error:function(e){r.reject(e)}};return $.ajax(i),r},imhere.TwitterAPI.prototype.updateStatus=function(e,t,r){var o=new $.Deferred,n={status:e,source:"metoro",lat:t.latitude,"long":t.longitude};return""!==r&&(n.in_reply_to_status_id=r),this.post("https://api.twitter.com/1.1/statuses/update.json",n,o),o.promise()},imhere.TwitterAPI.prototype.search=function(e,t,r){var o={consumerSecret:this.consumer.consumerSecret,tokenSecret:this.atoken_secret},n={method:"GET",action:"https://api.twitter.com/1.1/search/tweets.json",parameters:{oauth_signature_method:"HMAC-SHA1",oauth_consumer_key:this.consumer.consumerKey,oauth_token:this.atoken}};for(var s in t)n.parameters[s]=t[s];OAuth.setTimestampAndNonce(n),OAuth.SignatureMethod.sign(n,o);var a=OAuth.addToURL(n.action,n.parameters),i={type:n.method,url:a,dataType:"json",success:function(e){r.resolve(e)},error:function(e){r.reject(e)}};return $.ajax(i),r},imhere.TwitterAPI.prototype.searchAllTweets=function(){var e=new $.Deferred;query="%23imhereintyo";var t={q:query,count:100,result_type:"recent"};return this.search("https://api.twitter.com/1.1/search/tweets.json",t,e),e.promise()},imhere.TwitterAPI.prototype.initAPI=function(){var e;this.token="",this.token_secret="",this.atoken=e,this.atoken_secret=e};
imhere.LogonPage=function(){var e=function(){$("#logon-main-logon-a").addClass("ui-disabled"),$.mobile.loading("show",{text:"Now loading...",textVisible:!0,theme:"c",html:""});var e;imhereglobalcontext.twitterAPI.getRequestToken().then(function(){imhereglobalcontext.twitterAPI.userAuthentication().then(function(n,o){o!==e?imhereglobalcontext.twitterAPI.getAccessToken(n,o).then(function(e,n){var o=new imhere.IndexedDbAPI;o.openDB().then(function(){o.addToken("twitter",{at:e,ats:n}).then(function(){$.mobile.changePage("#main_page",{transition:"none"})})})},function(e){var n;alertify.error(e.responseText===n?"オフラインのためログオンに失敗しました":"予期せぬエラーのためログオンに失敗しました"),$.mobile.loading("hide"),$("#logon-main-logon-a").removeClass("ui-disabled")}):($.mobile.loading("hide"),$("#logon-main-logon-a").removeClass("ui-disabled"))})},function(e){var n;alertify.error(e.responseText===n?"オフラインのためログオンできません":"予期せぬエラーのためログオンに失敗しました"),$.mobile.loading("hide"),$("#logon-main-logon-a").removeClass("ui-disabled")})};return{initModule:function(){return $("#logon-main-logon-a").click(e),!0}}}();
imhere.MainPage=function(){var e=function(){var e=function(){imhere.utils.playAudio("main-main-imhere-music"),$("#main-main-imhere").addClass("animated rubberBand"),$("#main-main-imhere").bind("webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend",function(){n("main-main-imhere","rubberBand")})},t=function(e){$("#main-main-tweet-text").text(e),$("#main-main-tweet-text").addClass("animated fadeOut");var t=document.getElementById("main-main-tweet-text"),n=t.cloneNode(!0);t.parentNode.replaceChild(n,t),imhereglobalcontext.twitterAPI.updateStatus(e,"","").then(function(){},function(e){var t;if(e.responseText!==t){var n=JSON.parse(e.responseText);try{alertify.error(187==n.errors[0].code?"直近のTweetが同一位置データを参照しているため、このTweetは無効です":"予期せぬエラーのためTweetに失敗しました")}catch(e){alertify.error("予期せぬエラーのためTweetに失敗しました")}}else alertify.error("オフラインのためTweetに失敗しました")})},n=function(e,t){var n=document.getElementById(e);n.classList.remove("animated"),n.classList.remove(t);var i=n.cloneNode(!0);n.parentNode.replaceChild(i,n)};e();var i=new imhere.MetroAPI;i.getCurrentPosition().then(function(e){i.getNearestStation(e).then(function(n){"undefined"!==n?i.getNearestExit(e).then(function(a){t("undefined"!==a?n.title+"駅の"+a.title+"で待っています。誤差は最大"+imhere.utils.getAccuracyText(e.accuracy)+"です。<Lat:"+e.latitude+"/Long:"+e.longitude+"> "+IMHERE_HASHTAG+" ":n.title+"駅に到着しました。誤差は最大"+imhere.utils.getAccuracyText(e.accuracy)+"です。<Lat:"+e.latitude+"/Long:"+e.longitude+"> "+IMHERE_HASHTAG+" "),i.getRelatedTrainInformation(n).then(function(e){for(var t=0;t<e.length;t++)alertify.warning=alertify.extend("warning"),alertify.warning(e[t])},function(){alertify.error("オフラインのため処理に失敗しました")})},function(){alertify.error("オフラインのため処理に失敗しました")}):i.getNearestRailway(e).then(function(n){"undefined"!==n?i.getLocationBetweenStations(e,n).then(function(a){i.getTrainInformation(n).then(function(i){t(n.title+"線で"+a[0].title+"-"+a[1].title+"間を移動中です。"+n.title+"線は、"+i.trainInformationText+"誤差は最大"+imhere.utils.getAccuracyText(e.accuracy)+"です。<Lat:"+e.latitude+"/Long:"+e.longitude+"> "+IMHERE_HASHTAG+" ")},function(){alertify.error("オフラインのため処理に失敗しました")})},function(){alertify.error("オフラインのため処理に失敗しました")}):i.getNearStation(e).then(function(n){"undefined"!==n?(t("近くにMetroの駅はありません。最寄の駅は"+n.title+"になります。"+imhere.utils.geoDirection(e.latitude,e.longitude,n.lat,n.long)+"方向に"+imhere.utils.geoDistance(e.latitude,e.longitude,n.lat,n.long)+"m進んでください。誤差は最大"+imhere.utils.getAccuracyText(e.accuracy)+"です。<Lat:"+e.latitude+"/Long:"+e.longitude+"> "+IMHERE_HASHTAG+" "),i.getRelatedTrainInformation(n).then(function(e){for(var t=0;t<e.length;t++)alertify.warning=alertify.extend("warning"),alertify.warning(e[t])},function(){alertify.error("オフラインのため処理に失敗しました")})):t("Metro圏内にいません。∩(´･ω･`)つ―**:｡.:*ﾟ･* 誤差は最大"+imhere.utils.getAccuracyText(e.accuracy)+"です。<Lat:"+e.latitude+"/Long:"+e.longitude+"> "+IMHERE_HASHTAG+" ")},function(){alertify.error("オフラインのため処理に失敗しました")})},function(){alertify.error("オフラインのため処理に失敗しました")})},function(){alertify.error("オフラインのため処理に失敗しました")})},function(){alertify.error("位置情報が拾えませんでした")})},t=function(){alertify.set({labels:{ok:"Yes",cancel:"No"}}),alertify.set({buttonFocus:"ok"}),alertify.confirm("Do you want to log out？",function(e){if(e){var t=new imhere.IndexedDbAPI;t.openDB().then(function(){t.deleteToken("twitter").then(function(){imhereglobalcontext.twitterAPI.initAPI(),$.mobile.changePage("#logon_page",{transition:"none"})})})}})},n=function(){$.mobile.changePage("#googlemap_page",{transition:"none"})};return{initModule:function(){return $("#main-main-imhere-a").click(e),$("#main-header-logoff").click(t),$("#main-main-whereyourfriends-button").click(n),!0}}}();
imhere.GoogleMapPage=function(){var e=function(){imhere.GoogleMapPage.reloadModule()},t=function(e){var t=new imhere.MetroAPI;t.getCurrentPosition().then(function(t){for(var n=function(e,t){var n=document.createElement("div");n.innerHTML='<span style="color: blue">'+t.name+"さん was here at "+t.time+"!!!</span></br>"+t.tweet+"</br>";var a=n.appendChild(document.createElement("a"));a.href="#",a.appendChild(document.createTextNode("返信はこちら")),google.maps.event.addDomListener(a,"click",function(){o(t)}),google.maps.event.addListener(e,"click",function(){new google.maps.InfoWindow({content:n}).open(e.getMap(),e)})},a=new google.maps.LatLng(t.latitude,t.longitude),r={zoom:15,center:a,mapTypeId:google.maps.MapTypeId.ROADMAP},i=new google.maps.Map(document.getElementById("map_canvas"),r),l=0;l<e.length;l++){var g=new google.maps.MarkerImage(e[l].img,new google.maps.Size(35,40),new google.maps.Point(0,0),new google.maps.Point(35,40),new google.maps.Size(35,40)),s=new google.maps.Marker({position:new google.maps.LatLng(e[l].latitude,e[l].longitude),map:i,icon:g});n(s,e[l])}})},n=function(){$.mobile.changePage("#main_page",{transition:"none"})},o=function(e){var t="@"+e.screen_name+" ";alertify.prompt("Reply",function(t,n){t&&imhereglobalcontext.twitterAPI.updateStatus(n,"",e.id).then(function(){alertify.success("Tweet has successfully been sent....")},function(e){var t;if(e.responseText!==t){var n=JSON.parse(e.responseText);alertify.error(186==n.errors[0].code?"文字数が140文字を超えています":"予期せぬエラーのためTweetに失敗しました")}else alertify.error("オフラインのためTweetに失敗しました")})},t)};return{initModule:function(){return $("#googlemap-header-back").click(n),$("#googlemap-header-reflesh").click(e),!0},reloadModule:function(){var e=!1;try{google.map}catch(o){e=!0,alertify.alert("Google Mapを読み込めません。オンラインの状態で、アプリケーションを再起動してください。",function(){n()})}return 0==e&&(alertify.log("Now loading map........."),imhereglobalcontext.twitterAPI.searchAllTweets().then(function(e){for(var n,o=e.statuses,a={},r=0;r<o.length;r++){var i=o.length-1-r,l=o[i],g={};g.id=l.id_str,g.tweet=l.text,g.screen_name=l.user.screen_name,g.name=l.user.name,g.img=l.user.profile_image_url,g.time=imhere.utils.getCreatedTimeText(l.created_at);var s=imhere.utils.getPositionFromTweet(l.text);s!==n&&(g.latitude=s.latitude,g.longitude=s.longitude,a[l.user.id_str]=g)}var c=[];for(var m in a)c.push(a[m]);t(c)},function(e){var t;alertify.error(e.responseText===t?"オフラインのためマップ呼び出しに失敗しました":"予期せぬエラーのためマップ呼び出しに失敗しました")})),!0}}}();