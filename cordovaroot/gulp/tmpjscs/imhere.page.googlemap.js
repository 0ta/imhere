imhere.GoogleMapPage=function(){var e=function(){imhere.GoogleMapPage.reloadModule()},t=function(e){var t=new imhere.MetroAPI;t.getCurrentPosition().then(function(t){for(var n=function(e,t){var n=document.createElement("div");n.innerHTML='<span style="color: blue">'+t.name+"さん was here at "+t.time+"!!!</span></br>"+t.tweet+"</br>";var a=n.appendChild(document.createElement("a"));a.href="#",a.appendChild(document.createTextNode("返信はこちら")),google.maps.event.addDomListener(a,"click",function(){o(t)}),google.maps.event.addListener(e,"click",function(){new google.maps.InfoWindow({content:n}).open(e.getMap(),e)})},a=new google.maps.LatLng(t.latitude,t.longitude),r={zoom:15,center:a,mapTypeId:google.maps.MapTypeId.ROADMAP},i=new google.maps.Map(document.getElementById("map_canvas"),r),l=0;l<e.length;l++){var g=new google.maps.MarkerImage(e[l].img,new google.maps.Size(35,40),new google.maps.Point(0,0),new google.maps.Point(35,40),new google.maps.Size(35,40)),s=new google.maps.Marker({position:new google.maps.LatLng(e[l].latitude,e[l].longitude),map:i,icon:g});n(s,e[l])}})},n=function(){$.mobile.changePage("#main_page",{transition:"none"})},o=function(e){var t="@"+e.screen_name+" ";alertify.prompt("Reply",function(t,n){t&&imhereglobalcontext.twitterAPI.updateStatus(n,"",e.id).then(function(){alertify.success("Tweet has successfully been sent....")},function(e){var t;if(e.responseText!==t){var n=JSON.parse(e.responseText);alertify.error(186==n.errors[0].code?"文字数が140文字を超えています":"予期せぬエラーのためTweetに失敗しました")}else alertify.error("オフラインのためTweetに失敗しました")})},t)};return{initModule:function(){return $("#googlemap-header-back").click(n),$("#googlemap-header-reflesh").click(e),!0},reloadModule:function(){var e=!1;try{google.map}catch(o){e=!0,alertify.alert("Google Mapを読み込めません。オンラインの状態で、アプリケーションを再起動してください。",function(){n()})}return 0==e&&(alertify.log("Now loading map........."),imhereglobalcontext.twitterAPI.searchAllTweets().then(function(e){for(var n,o=e.statuses,a={},r=0;r<o.length;r++){var i=o.length-1-r,l=o[i],g={};g.id=l.id_str,g.tweet=l.text,g.screen_name=l.user.screen_name,g.name=l.user.name,g.img=l.user.profile_image_url,g.time=imhere.utils.getCreatedTimeText(l.created_at);var s=imhere.utils.getPositionFromTweet(l.text);s!==n&&(g.latitude=s.latitude,g.longitude=s.longitude,a[l.user.id_str]=g)}var c=[];for(var m in a)c.push(a[m]);t(c)},function(e){var t;alertify.error(e.responseText===t?"オフラインのためマップ呼び出しに失敗しました":"予期せぬエラーのためマップ呼び出しに失敗しました")})),!0}}}();